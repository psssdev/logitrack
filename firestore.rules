rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthed() {
      return request.auth != null;
    }

    // Returns the companyId associated with the authenticated user.
    function getUserCompanyId() {
      // Important: This assumes a 'users' collection where each user document
      // has a 'companyId' field.
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      if (userDoc.data.size() == 0) {
        return ""; // Return empty string if user profile doesn't exist
      }
      return userDoc.data.companyId;
    }

    // Checks if the requesting user is a member of the specified company.
    function isCompanyMember(companyId) {
      return isAuthed() && getUserCompanyId() == companyId;
    }

    // Allow users to read and write their own profile document.
    match /users/{userId} {
      allow read, write: if isAuthed() && request.auth.uid == userId;
    }
    
    // Explicitly allow list operations on financialCategories for company members.
    // This is crucial for queries with `where` clauses.
    match /companies/{companyId}/financialCategories/{categoryId} {
      allow read, write: if isCompanyMember(companyId);
    }
    
    // Grant read and write access to all other documents within any subcollection
    // of a company, but only for authenticated members of that company.
    match /companies/{companyId}/{subcollection}/{docId=**} {
      allow read, write: if isCompanyMember(companyId);
    }
  }
}
