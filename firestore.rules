rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isUserAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Função que usa o Custom Claim em vez de ler o documento do usuário
    function getUserCompanyId() {
      return request.auth.token.companyId;
    }

    // Função que usa o Custom Claim
    function isUserInCompany(companyId) {
      return isUserAuthenticated() && getUserCompanyId() == companyId;
    }
    
    // As regras do usuário podem ser mais simples agora
    match /users/{userId} {
      allow read: if isOwner(userId);
      // Criação/Update só podem ser feitos via backend (API Route)
      allow create, update, delete: if false; 
    }

    match /companies/{companyId} {
      // Leitura permitida se o usuário pertence à empresa (via custom claim)
      allow read: if isUserInCompany(companyId);
      // Escrita/Criação bloqueada para o cliente, deve ser feita pela API de provisionamento
      allow create, update, delete: if false;
    }

    // Esta regra agora protege todas as subcoleções de uma empresa
    match /companies/{companyId}/{document=**} {
      allow read, write: if isUserInCompany(companyId);
    }
  }
}
