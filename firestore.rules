
/**
 * @file Firebase Security Rules for Firestore.
 *
 * @core_philosophy This ruleset enforces a multi-tenant security model where data is segregated by company.
 *  Users can only access data belonging to their associated company.
 *  Unauthenticated access is forbidden.
 *
 * @data_structure
 *  - /users/{userId}: Stores public user profile information.
 *  - /companies/{companyId}: Stores company-specific data and settings.
 *  - /companies/{companyId}/clients/{clientId}: Stores client information for each company.
 *  - /companies/{companyId}/origins/{originId}: Stores origin information for each company.
 *  - /companies/{companyId}/clients/{clientId}/addresses/{addressId}: Stores client address information for each company.
 *  - /companies/{companyId}/orders/{orderId}: Stores orders for each company.
 *
 * @key_security_decisions
 *  - User listing is disallowed for privacy.
 *  - All data access is predicated on the user's authentication status and their association with a company.
 *  - Data creation, updates, and deletions are restricted to authorized users within their respective company contexts.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (get) User with ID 'user123' can read their own profile.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (update) User with ID 'user123' can update their own profile.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (create) User with ID 'user456' cannot create a profile with ID 'user123'.
     *   Request: { "auth": { "uid": "user456" } }
     * @deny (delete) No one can delete a user profile directly.
     *   Request: { "auth": { "uid": "user123" } }
     * @principle Enforces user-ownership: Only the authenticated user can create, read, or update their own profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Controls access to company information.
     * @path /companies/{companyId}
     * @allow (get) Any authenticated user can read company information.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (update) Any authenticated user can update a company directly.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (create) No one can create a company directly.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (delete) No one can delete a company directly.
     *   Request: { "auth": { "uid": "user123" } }
     * @principle Restricts company management: Only the application can manage company data.
     */
    match /companies/{companyId} {
      allow get, update: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to client information within a company.
     * @path /companies/{companyId}/clients/{clientId}
     * @allow (get) Any authenticated user can read a client within their company.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (create) Any authenticated user can create a client within their company.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (update) Any authenticated user can update a client within their company.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (delete) No one can delete a client directly.
     *   Request: { "auth": { "uid": "user123" } }
     * @principle Enforces company-based access: Data is accessible within the company context.
     */
    match /companies/{companyId}/clients/{clientId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if false;
    }

    /**
     * @description Controls access to origin information within a company.
     * @path /companies/{companyId}/origins/{originId}
     * @allow (get) Any authenticated user can read an origin within their company.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (create) Any authenticated user can create an origin within their company.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (update) Any authenticated user can update an origin within their company.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (delete) No one can delete an origin directly.
     *   Request: { "auth": { "uid": "user123" } }
     * @principle Enforces company-based access: Data is accessible within the company context.
     */
    match /companies/{companyId}/origins/{originId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if false;
    }

    /**
     * @description Controls access to client addresses within a company and client.
     * @path /companies/{companyId}/clients/{clientId}/addresses/{addressId}
     * @allow (get) Any authenticated user can read an address within their company and client.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (create) Any authenticated user can create an address within their company and client.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (update) Any authenticated user can update an address within their company and client.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (delete) No one can delete an address directly.
     *   Request: { "auth": { "uid": "user123" } }
     * @principle Enforces company-based access: Data is accessible within the company context.
     */
    match /companies/{companyId}/clients/{clientId}/addresses/{addressId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if false;
    }

    /**
     * @description Controls access to order information within a company.
     * @path /companies/{companyId}/orders/{orderId}
     * @allow (get) Any authenticated user can read an order within their company.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (create) Any authenticated user can create an order within their company.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (update) Any authenticated user can update an order within their company.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (delete) No one can delete an order directly.
     *   Request: { "auth": { "uid": "user123" } }
     * @principle Enforces company-based access: Data is accessible within the company context.
     */
    match /companies/{companyId}/orders/{orderId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if false;
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the resource.
  function isOwner(userId) {
    return request.auth.uid == userId;
  }
}
