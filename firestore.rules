/**
 * @fileoverview Firestore Security Rules for the transport app.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant security model based on company ownership.
 * Users can only access data belonging to their associated company.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information, including the companyId to which they belong.
 * - /companies/{companyId}: Stores company-level data and configuration.
 * - Subcollections under /companies/{companyId}: Contain data specific to that company, such as clients, origins, orders, and drivers.
 *
 * Key Security Decisions:
 * - Users can only list drivers that belong to their company.
 * - All write operations are restricted to authenticated users with the appropriate company ID.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     * @param {string} userId The user ID to compare against.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     * @param {string} userId The user ID to compare against.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user's companyId matches the provided companyId.
     * @param {string} companyId The company ID to compare against.
     */
    function isCompanyOwner(companyId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
    }

    /**
     * @description Stores public information about a user.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates their profile.
     *   - Request: { auth: { uid: 'user123' } }
     *   - Data: { id: 'user123', displayName: 'John Doe', email: 'john.doe@example.com' }
     * @deny (create) User with UID 'user456' attempts to create a profile for user 'user123'.
     *   - Request: { auth: { uid: 'user456' } }
     *   - Data: { id: 'user123', displayName: 'John Doe', email: 'john.doe@example.com' }
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if false;
    }

    /**
     * @description Stores the settings and branding for a company.
     * @path /companies/{companyId}
     * @allow (create) User who owns the company can create the company profile.
     *   - Request: { auth: { uid: 'user123' } }
     *   - Data: { id: 'company1', nomeFantasia: 'Example Transport' }
     * @deny (update) User who does not own the company tries to modify the company profile.
     *   - Request: { auth: { uid: 'user456' } }
     *   - Data: { nomeFantasia: 'New Name' }
     * @principle Enforces document ownership for writes.
     */
    match /companies/{companyId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn(); // TODO: Add admin-only create rule
      allow update: if isSignedIn() && isCompanyOwner(companyId);
      allow delete: if false; // TODO: Add admin-only delete rule
    }

    /**
     * @description Stores customer information for a specific company.
     * @path /companies/{companyId}/clients/{clientId}
     * @allow (create) User from company 'company1' creates a new client.
     *   - Request: { auth: { uid: 'user123' } }
     *   - Data: { nome: 'Alice', telefone: '123-456-7890' }
     * @deny (update) User from a different company tries to modify the client data.
     *   - Request: { auth: { uid: 'user456' } }
     *   - Data: { nome: 'Bob' }
     * @principle Enforces multi-tenant data access.
     */
    match /companies/{companyId}/clients/{clientId} {
      allow get: if isSignedIn() && isCompanyOwner(companyId);
      allow list: if isSignedIn() && isCompanyOwner(companyId);
      allow create: if isSignedIn() && isCompanyOwner(companyId);
      allow update: if isSignedIn() && isCompanyOwner(companyId);
      allow delete: if isSignedIn() && isCompanyOwner(companyId);
    }

    /**
     * @description Stores shipment origin points for a specific company.
     * @path /companies/{companyId}/origins/{originId}
     * @allow (create) User from company 'company1' creates a new origin.
     *   - Request: { auth: { uid: 'user123' } }
     *   - Data: { name: 'Warehouse A', address: '123 Main St' }
     * @deny (update) User from a different company tries to modify the origin data.
     *   - Request: { auth: { uid: 'user456' } }
     *   - Data: { name: 'Warehouse B' }
     * @principle Enforces multi-tenant data access.
     */
    match /companies/{companyId}/origins/{originId} {
      allow get: if isSignedIn() && isCompanyOwner(companyId);
      allow list: if isSignedIn() && isCompanyOwner(companyId);
      allow create: if isSignedIn() && isCompanyOwner(companyId);
      allow update: if isSignedIn() && isCompanyOwner(companyId);
      allow delete: if isSignedIn() && isCompanyOwner(companyId);
    }

    /**
     * @description Stores addresses for a specific client.
     * @path /companies/{companyId}/clients/{clientId}/addresses/{addressId}
     * @allow (create) User from company 'company1' creates an address for client 'client1'.
     *   - Request: { auth: { uid: 'user123' } }
     *   - Data: { label: 'Home', logradouro: '456 Elm St' }
     * @deny (update) User from a different company tries to modify the address.
     *   - Request: { auth: { uid: 'user456' } }
     *   - Data: { logradouro: '789 Oak St' }
     * @principle Enforces multi-tenant data access.
     */
    match /companies/{companyId}/clients/{clientId}/addresses/{addressId} {
      allow get: if isSignedIn() && isCompanyOwner(companyId);
      allow list: if isSignedIn() && isCompanyOwner(companyId);
      allow create: if isSignedIn() && isCompanyOwner(companyId);
      allow update: if isSignedIn() && isCompanyOwner(companyId);
      allow delete: if isSignedIn() && isCompanyOwner(companyId);
    }

    /**
     * @description Stores all orders for a specific company.
     * @path /companies/{companyId}/orders/{orderId}
     * @allow (create) User from company 'company1' creates a new order.
     *   - Request: { auth: { uid: 'user123' } }
     *   - Data: { codigoRastreio: 'TR-123', nomeCliente: 'Charlie' }
     * @deny (update) User from a different company tries to modify the order data.
     *   - Request: { auth: { uid: 'user456' } }
     *   - Data: { nomeCliente: 'David' }
     * @principle Enforces multi-tenant data access.
     */
    match /companies/{companyId}/orders/{orderId} {
      allow get: if isSignedIn() && isCompanyOwner(companyId);
      allow list: if isSignedIn() && isCompanyOwner(companyId);
      allow create: if isSignedIn() && isCompanyOwner(companyId);
      allow update: if isSignedIn() && isCompanyOwner(companyId);
      allow delete: if isSignedIn() && isCompanyOwner(companyId);
    }

    /**
     * @description Stores all Avisame campaigns for a company.
     * @path /companies/{companyId}/avisame_campaigns/{campaignId}
     * @allow (create) User from company 'company1' creates a new Avisame campaign.
     *   - Request: { auth: { uid: 'user123' } }
     *   - Data: { city: 'Anytown', messageTemplate: 'Hello!' }
     * @deny (update) User from a different company tries to modify the campaign data.
     *   - Request: { auth: { uid: 'user456' } }
     *   - Data: { messageTemplate: 'Goodbye!' }
     */
    match /companies/{companyId}/avisame_campaigns/{campaignId} {
      allow get: if isSignedIn() && isCompanyOwner(companyId);
      allow list: if isSignedIn() && isCompanyOwner(companyId);
      allow create: if isSignedIn() && isCompanyOwner(companyId);
      allow update: if isSignedIn() && isCompanyOwner(companyId);
      allow delete: if isSignedIn() && isCompanyOwner(companyId);
    }

    /**
     * @description Stores all individual delivery statuses for Avisame campaigns.
     * @path /companies/{companyId}/avisame_deliveries/{deliveryId}
     * @allow (create) User from company 'company1' creates a new Avisame delivery status.
     *   - Request: { auth: { uid: 'user123' } }
     *   - Data: { campaignId: 'campaign1', customerId: 'customer1' }
     * @deny (update) User from a different company tries to modify the delivery status.
     *   - Request: { auth: { uid: 'user456' } }
     *   - Data: { status: 'sent' }
     */
    match /companies/{companyId}/avisame_deliveries/{deliveryId} {
      allow get: if isSignedIn() && isCompanyOwner(companyId);
      allow list: if isSignedIn() && isCompanyOwner(companyId);
      allow create: if isSignedIn() && isCompanyOwner(companyId);
      allow update: if isSignedIn() && isCompanyOwner(companyId);
      allow delete: if isSignedIn() && isCompanyOwner(companyId);
    }

      /**
       * @description Stores all drivers for a specific company.
       * @path /companies/{companyId}/drivers/{driverId}
       * @allow (list) User from company can list drivers.
       *   - Request: { auth: { uid: 'user123' } }
       * @principle Enforces multi-tenant data access.
       */
      match /companies/{companyId}/drivers/{driverId} {
        allow get: if isSignedIn() && isCompanyOwner(companyId);
        allow list: if isSignedIn() && isCompanyOwner(companyId);
        allow create: if isSignedIn() && isCompanyOwner(companyId);
        allow update: if isSignedIn() && isCompanyOwner(companyId);
        allow delete: if isSignedIn() && isCompanyOwner(companyId);
      }
  }
}