/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model where data is segregated by company.
 * Users can only access data within their assigned company.
 *
 * Data Structure:
 * - /users/{userId}: Stores public user profile information.  Accessible only to the user.
 * - /companies/{companyId}/...: All company-specific data is stored under a company ID.
 *   - /companies/{companyId}/clients/{clientId}: Client information for a company.
 *   - /companies/{companyId}/origins/{originId}: Shipment origin points for a company.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Company data is isolated.  Users need to be authenticated to access company data.
 *
 * Denormalization for Authorization:
 *  - Company ID is used as a top-level collection key, making company-based access control straightforward.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (get, update, delete) if request.auth.uid == userId
     * @allow (create) if request.auth.uid == request.resource.data.id
     * @deny (get, update, delete) if request.auth.uid != userId
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows authenticated users to manage clients within their company.
     * @path /companies/{companyId}/clients/{clientId}
     * @allow (create) if isSignedIn()
     * @allow (get, list, update, delete) if isSignedIn()
     * @deny (create, get, list, update, delete) if !isSignedIn()
     * @principle Requires authentication for company client data access.
     */
    match /companies/{companyId}/clients/{clientId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

     /**
      * @description Allows authenticated users to manage origins within their company.
      * @path /companies/{companyId}/origins/{originId}
      * @allow (create) if isSignedIn()
      * @allow (get, list, update, delete) if isSignedIn()
      * @deny (create, get, list, update, delete) if !isSignedIn()
      * @principle Requires authentication for company origin data access.
      */
    match /companies/{companyId}/origins/{originId} {
         function isSignedIn() {
            return request.auth != null;
         }

         allow get: if isSignedIn();
         allow list: if isSignedIn();
         allow create: if isSignedIn();
         allow update: if isSignedIn();
         allow delete: if isSignedIn();
      }
  }
}