rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthed() {
      return request.auth != null;
    }

    // Returns the companyId associated with the authenticated user.
    function getUserCompanyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }

    // Checks if the requesting user is a member of the specified company.
    function isCompanyMember(companyId) {
      return isAuthed() && getUserCompanyId() == companyId;
    }

    // Default deny all access to prevent unintentional data exposure.
    match /{document=**} {
      allow read, write: if false;
    }

    // Allow users to read and write their own profile document.
    match /users/{userId} {
      allow read, write: if isAuthed() && request.auth.uid == userId;
    }

    // Allow authenticated members of a company to read the main company document.
    // This is essential for client-side code to access company-wide settings.
    match /companies/{companyId} {
      allow read: if isCompanyMember(companyId);
      // Only company admins should be able to update company settings.
      // This can be refined later with role-based logic.
      allow update: if isCompanyMember(companyId); 
    }
    
    // Grant read and write access to all documents within any subcollection
    // of a company, but only for authenticated members of that company.
    // This single rule covers orders, clients, drivers, vehicles, financialEntries, etc.
    match /companies/{companyId}/{subcollection}/{docId=**} {
      allow read, write: if isCompanyMember(companyId);
    }
  }
}
