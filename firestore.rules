/**
 * @fileoverview Firestore Security Rules for the transport app.
 *
 * Core Philosophy:
 * This ruleset implements a multi-tenant security model. Data is partitioned by
 * company ID. Most data is only accessible to authenticated users.
 *
 * Data Structure:
 * - /users/{userId}: User profile information.
 * - /companies/{companyId}/...: All company-related data.
 *   - /clients/{clientId}: Client information for a company.
 *   - /origins/{originId}: Shipment origin points for a company.
 *   - /clients/{clientId}/addresses/{addressId}: Addresses for a specific client.
 *   - /orders/{orderId}: Orders for a specific company.
 *   - /drivers/{driverId}: Drivers working for the company
 *
 * Key Security Decisions:
 * - Users can only read/write their own profile data.
 * - All company-related data is scoped to the company and requires authentication.
 * - Listing of users is disallowed.
 * - Read access to company collections is restricted to authenticated users, with no role-based access control.
 * - Write access to company collections is restricted to authenticated users, with the `createdBy` field enforced as the author.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (get, create, update, delete): if the user is the owner of the profile.
     * @deny (get, create, update, delete): if the user is not the owner of the profile.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to client information within a company.
     * @path /companies/{companyId}/clients/{clientId}
     * @allow (get, list): if the user is authenticated.
     * @allow (create): if the user is authenticated. Validates that the `createdBy` field in the new document matches the authenticated user's ID.
     * @allow (update, delete): if the user is authenticated and the document exists.
     * @deny (get, list, create, update, delete): if the user is not authenticated.
     * @principle Restricts data access to authenticated users within a multi-tenant company structure.
     */
    match /companies/{companyId}/clients/{clientId} {
        function isSignedIn() {
          return request.auth != null;
        }

        allow get: if isSignedIn();
        allow list: if isSignedIn();

        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
    }

     /**
      * @description Controls access to shipment origin points within a company.
      * @path /companies/{companyId}/origins/{originId}
      * @allow (get, list): if the user is authenticated.
      * @allow (create): if the user is authenticated. Validates that the `createdBy` field in the new document matches the authenticated user's ID.
      * @allow (update, delete): if the user is authenticated and the document exists.
      * @deny (get, list, create, update, delete): if the user is not authenticated.
      * @principle Restricts data access to authenticated users within a multi-tenant company structure.
      */
    match /companies/{companyId}/origins/{originId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to addresses for a specific client within a company.
     * @path /companies/{companyId}/clients/{clientId}/addresses/{addressId}
     * @allow (get, list): if the user is authenticated.
     * @allow (create): if the user is authenticated. Validates that the `createdBy` field in the new document matches the authenticated user's ID.
     * @allow (update, delete): if the user is authenticated and the document exists.
     * @deny (get, list, create, update, delete): if the user is not authenticated.
     * @principle Restricts data access to authenticated users within a multi-tenant company structure.
     */
    match /companies/{companyId}/clients/{clientId}/addresses/{addressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to orders within a company.
     * @path /companies/{companyId}/orders/{orderId}
     * @allow (get, list): if the user is authenticated.
     * @allow (create): if the user is authenticated. Validates that the `createdBy` field in the new document matches the authenticated user's ID.
     * @allow (update, delete): if the user is authenticated and the document exists.
     * @deny (get, list, create, update, delete): if the user is not authenticated.
     * @principle Restricts data access to authenticated users within a multi-tenant company structure.
     */
    match /companies/{companyId}/orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }
}