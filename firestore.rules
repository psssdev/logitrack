rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (get, create, update, delete): Authenticated user accessing their own profile.
     * @deny (get, create, update, delete): Any other user attempting to access another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is disallowed.
      allow create: if isOwner(userId) && request.auth.token.email == request.resource.data.email;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to company profile information.
     * @path /companies/{companyId}
     * @allow (get, list): Public read access to company profiles.
     * @allow (create): Authenticated user creating a new company profile.
     * @allow (update, delete): Not allowed.
     * @principle Public read access with owner-only writes; enforces company-level isolation.
     */
    match /companies/{companyId} {
      allow get, list: if true;
      allow create: if request.auth != null;
      allow update, delete: if false;
    }

    /**
     * @description Controls access to client information within a company.
     * @path /companies/{companyId}/clients/{clientId}
     * @allow (get, list, create, update, delete): Authenticated user within the company accessing client data.
     * @deny (get, list, create, update, delete): Access from outside the company.
     * @principle Enforces company-level data isolation.
     */
    match /companies/{companyId}/clients/{clientId} {
        function isCompanyUser(companyId) {
            return request.auth != null && request.params.companyId == companyId;
        }
        allow get: if isCompanyUser(companyId);
        allow list: if isCompanyUser(companyId);
        allow create: if isCompanyUser(companyId);
        allow update: if isCompanyUser(companyId);
        allow delete: if isCompanyUser(companyId);
    }

        /**
     * @description Controls access to origins information within a company.
     * @path /companies/{companyId}/origins/{originId}
     * @allow (get, list, create, update, delete): Authenticated user within the company accessing origins data.
     * @deny (get, list, create, update, delete): Access from outside the company.
     * @principle Enforces company-level data isolation.
     */
     match /companies/{companyId}/origins/{originId} {
        function isCompanyUser(companyId) {
            return request.auth != null && request.params.companyId == companyId;
        }
        allow get: if isCompanyUser(companyId);
        allow list: if isCompanyUser(companyId);
        allow create: if isCompanyUser(companyId);
        allow update: if isCompanyUser(companyId);
        allow delete: if isCompanyUser(companyId);
    }

    /**
     * @description Controls access to addresses for a specific client within a company.
     * @path /companies/{companyId}/clients/{clientId}/addresses/{addressId}
     * @allow (get, list, create, update, delete): Authenticated user within the company accessing client addresses.
     * @deny (get, list, create, update, delete): Access from outside the company.
     * @principle Enforces company-level data isolation; restricts access to client-specific data.
     */
    match /companies/{companyId}/clients/{clientId}/addresses/{addressId} {
        function isCompanyUser(companyId) {
            return request.auth != null && request.params.companyId == companyId;
        }
        allow get: if isCompanyUser(companyId);
        allow list: if isCompanyUser(companyId);
        allow create: if isCompanyUser(companyId);
        allow update: if isCompanyUser(companyId);
        allow delete: if isCompanyUser(companyId);
    }

    /**
     * @description Controls access to order information within a company.
     * @path /companies/{companyId}/orders/{orderId}
     * @allow (get, list, create, update, delete): Authenticated user within the company accessing order data.
     * @deny (get, list, create, update, delete): Access from outside the company.
     * @principle Enforces company-level data isolation.
     */
    match /companies/{companyId}/orders/{orderId} {
        function isCompanyUser(companyId) {
            return request.auth != null && request.params.companyId == companyId;
        }
        allow get: if isCompanyUser(companyId);
        allow list: if isCompanyUser(companyId);
        allow create: if isCompanyUser(companyId);
        allow update: if isCompanyUser(companyId);
        allow delete: if isCompanyUser(companyId);
    }

    /**
     * @description Controls access to Avisame campaigns within a company.
     * @path /companies/{companyId}/avisame_campaigns/{campaignId}
     * @allow (get, list, create, update, delete): Authenticated user within the company accessing Avisame campaign data.
     * @deny (get, list, create, update, delete): Access from outside the company.
     */
    match /companies/{companyId}/avisame_campaigns/{campaignId} {
      function isCompanyUser(companyId) {
            return request.auth != null && request.params.companyId == companyId;
        }
        allow get: if isCompanyUser(companyId);
        allow list: if isCompanyUser(companyId);
        allow create: if isCompanyUser(companyId);
        allow update: if isCompanyUser(companyId);
        allow delete: if isCompanyUser(companyId);
    }

    /**
     * @description Controls access to Avisame delivery statuses within a company.
     * @path /companies/{companyId}/avisame_deliveries/{deliveryId}
     * @allow (get, list, create, update, delete): Authenticated user within the company accessing Avisame delivery status data.
     * @deny (get, list, create, update, delete): Access from outside the company.
     */
    match /companies/{companyId}/avisame_deliveries/{deliveryId} {
      function isCompanyUser(companyId) {
            return request.auth != null && request.params.companyId == companyId;
        }
        allow get: if isCompanyUser(companyId);
        allow list: if isCompanyUser(companyId);
        allow create: if isCompanyUser(companyId);
        allow update: if isCompanyUser(companyId);
        allow delete: if isCompanyUser(companyId);
    }
  }
}