/**
 * @fileOverview Firestore Security Rules for the transport system.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant security model where data is primarily segregated by company ID.
 * Users can only access data belonging to their associated company.
 * Access to user profiles is restricted to the individual user.
 *
 * Data Structure:
 * - /users/{userId}: Stores public user profile information.  Access is limited to the owning user.
 * - /companies/{companyId}/...: All company-specific data is nested under a company ID.
 *   - /clients/{clientId}: Client information for a specific company.
 *   - /origins/{originId}: Shipment origin points for a specific company.
 *   - /addresses/{addressId}: Client addresses, nested under clients.
 *   - /orders/{orderId}: Order information for a specific company.
 *
 * Key Security Decisions:
 * - User listing is disallowed for privacy.
 * - Strict ownership is enforced for user profiles.
 * - Company-level access is not explicitly role-based in this initial prototype but is designed to be extended.
 * - The ruleset prioritizes security by defaulting to denying access unless explicitly granted.
 *
 * Denormalization for Authorization:
 * - Company ID is implicitly denormalized into all company-specific subcollections, enabling company-based access control.
 *
 * Structural Segregation:
 * - Private user data (e.g., settings) should be stored in a separate subcollection under /users/{userId} to avoid accidental public exposure.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages access to user profile information.
     * @path /users/{userId}
     * @allow (get, create, update, delete, list) if the request is made by the user with matching userId.
     * @deny (get, create, update, delete, list) if the request is made by a different user.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // User listing is not allowed for privacy.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages access to client information for a specific company.
     * @path /companies/{companyId}/clients/{clientId}
     * @allow (get, create, update, delete, list) if the request is made by an authenticated user.
     * @deny (get, create, update, delete, list) if the request is unauthenticated.
     * @principle Enforces company-level access control.
     */
    match /companies/{companyId}/clients/{clientId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages access to shipment origins for a specific company.
     * @path /companies/{companyId}/origins/{originId}
     * @allow (get, create, update, delete, list) if the request is made by an authenticated user.
     * @deny (get, create, update, delete, list) if the request is unauthenticated.
     * @principle Enforces company-level access control.
     */
    match /companies/{companyId}/origins/{originId} {
          function isSignedIn() {
              return request.auth != null;
          }

          allow get: if isSignedIn();
          allow list: if isSignedIn();
          allow create: if isSignedIn();
          allow update: if isSignedIn();
          allow delete: if isSignedIn();
    }

    /**
     * @description Manages access to addresses for a specific client within a company.
     * @path /companies/{companyId}/clients/{clientId}/addresses/{addressId}
     * @allow (get, create, update, delete, list) if the request is made by an authenticated user.
     * @deny (get, create, update, delete, list) if the request is unauthenticated.
     * @principle Enforces company-level access control with client context.
     */
    match /companies/{companyId}/clients/{clientId}/addresses/{addressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages access to orders for a specific company.
     * @path /companies/{companyId}/orders/{orderId}
     * @allow (get, create, update, delete, list) if the request is made by an authenticated user.
     * @deny (get, create, update, delete, list) if the request is unauthenticated.
     * @principle Enforces company-level access control.
     */
    match /companies/{companyId}/orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}