/**
 * @fileOverview Firestore Security Rules for the transport app.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant security model where companies have isolated data.
 * Users must be authenticated to access any data.
 * Data access is generally restricted to company-level access.
 *
 * Data Structure:
 * - /users/{userId}: Stores public user profiles.
 * - /companies/{companyId}/clients/{clientId}: Stores client data for each company.
 * - /companies/{companyId}/origins/{originId}: Stores shipment origins for each company.
 * - /companies/{companyId}/clients/{clientId}/addresses/{addressId}: Stores client addresses.
 * - /companies/{companyId}/orders/{orderId}: Stores order data for each company.
 *
 * Key Security Decisions:
 * - Only authenticated users can access the database.
 * - Companies can only access their own data.
 * - Users cannot list all users; they can only access their own profile.
 * - Strict ownership is enforced for writes to prevent unauthorized modifications.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profile data.
     * @path /users/{userId}
     * @allow (get) Authenticated user can read their own profile.
     * @allow (create) Authenticated user can create their own profile if the userId matches their auth.uid.
     * @allow (update) Authenticated user can update their own profile if the userId matches their auth.uid.
     * @allow (delete) Authenticated user can delete their own profile if the userId matches their auth.uid.
     * @deny (get) Authenticated user cannot read other user's profiles.
     * @deny (create) Unauthenticated user cannot create a profile.
     * @deny (update) Authenticated user cannot update other user's profiles.
     * @deny (delete) Authenticated user cannot delete other user's profiles.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requested userId matches the authenticated user's uid
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      // Helper function to check if the user is signed in and the document exists
      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is not permitted

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures client data for a specific company.
     * @path /companies/{companyId}/clients/{clientId}
     * @allow (get) Authenticated user can read client data within their company.
     * @allow (list) Authenticated user can list clients within their company.
     * @allow (create) Authenticated user can create client data within their company.
     * @allow (update) Authenticated user can update client data within their company.
     * @allow (delete) Authenticated user can delete client data within their company.
     * @deny (get) Authenticated user cannot read client data from other companies.
     * @deny (create) Unauthenticated user cannot create client data.
     * @deny (update) Authenticated user cannot update client data from other companies.
     * @deny (delete) Authenticated user cannot delete client data from other companies.
     * @principle Enforces company-level access for data.
     */
    match /companies/{companyId}/clients/{clientId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isCompany(companyId) {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId; // All authenticated users have access to *a* company, but we don't know which one without denormalization
      }

      function isExistingCompany(companyId) {
        return isCompany(companyId) && resource.data != null;
      }

      allow get: if isCompany(companyId);
      allow list: if isCompany(companyId);
      allow create: if isCompany(companyId);
      allow update: if isExistingCompany(companyId);
      allow delete: if isExistingCompany(companyId);
    }

       /**
        * @description Secures shipment origin data for a specific company.
        * @path /companies/{companyId}/origins/{originId}
        * @allow (get) Authenticated user can read origin data within their company.
        * @allow (list) Authenticated user can list origins within their company.
        * @allow (create) Authenticated user can create origin data within their company.
        * @allow (update) Authenticated user can update origin data within their company.
        * @allow (delete) Authenticated user can delete origin data within their company.
        * @deny (get) Authenticated user cannot read origin data from other companies.
        * @deny (create) Unauthenticated user cannot create origin data.
        * @deny (update) Authenticated user cannot update origin data from other companies.
        * @deny (delete) Authenticated user cannot delete origin data from other companies.
        * @principle Enforces company-level access for data.
        */
      match /companies/{companyId}/origins/{originId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isCompany(companyId) {
          return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId; // All authenticated users have access to *a* company, but we don't know which one without denormalization
        }

        function isExistingCompany(companyId) {
          return isCompany(companyId) && resource.data != null;
        }

        allow get: if isCompany(companyId);
        allow list: if isCompany(companyId);
        allow create: if isCompany(companyId);
        allow update: if isExistingCompany(companyId);
        allow delete: if isExistingCompany(companyId);
      }

    /**
     * @description Secures addresses for a specific client.
     * @path /companies/{companyId}/clients/{clientId}/addresses/{addressId}
     * @allow (get) Authenticated user can read addresses within their company and client.
     * @allow (list) Authenticated user can list addresses within their company and client.
     * @allow (create) Authenticated user can create addresses within their company and client.
     * @allow (update) Authenticated user can update addresses within their company and client.
     * @allow (delete) Authenticated user can delete addresses within their company and client.
     * @deny (get) Authenticated user cannot read addresses from other companies or clients.
     * @deny (create) Unauthenticated user cannot create addresses.
     * @deny (update) Authenticated user cannot update addresses from other companies or clients.
     * @deny (delete) Authenticated user cannot delete addresses from other companies or clients.
     * @principle Enforces company and client-level access for data.
     */
    match /companies/{companyId}/clients/{clientId}/addresses/{addressId} {
      function isSignedIn() {
        return request.auth != null;
      }

     function isCompany(companyId) {
          return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId; // All authenticated users have access to *a* company, but we don't know which one without denormalization
        }

      function isExistingCompany(companyId) {
        return isCompany(companyId) && resource.data != null;
      }


      allow get: if isCompany(companyId);
      allow list: if isCompany(companyId);
      allow create: if isCompany(companyId);
      allow update: if isExistingCompany(companyId);
      allow delete: if isExistingCompany(companyId);
    }

    /**
     * @description Secures order data for a specific company.
     * @path /companies/{companyId}/orders/{orderId}
     * @allow (get) Authenticated user can read order data within their company.
     * @allow (list) Authenticated user can list orders within their company.
     * @allow (create) Authenticated user can create order data within their company.
     * @allow (update) Authenticated user can update order data within their company.
     * @allow (delete) Authenticated user can delete order data within their company.
     * @deny (get) Authenticated user cannot read order data from other companies.
     * @deny (create) Unauthenticated user cannot create order data.
     * @deny (update) Authenticated user cannot update order data from other companies.
     * @deny (delete) Authenticated user cannot delete order data from other companies.
     * @principle Enforces company-level access for data.
     */
    match /companies/{companyId}/orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

     function isCompany(companyId) {
          return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId; // All authenticated users have access to *a* company, but we don't know which one without denormalization
        }

      function isExistingCompany(companyId) {
        return isCompany(companyId) && resource.data != null;
      }

      allow get: if isCompany(companyId);
      allow list: if isCompany(companyId);
      allow create: if isCompany(companyId);
      allow update: if isExistingCompany(companyId);
      allow delete: if isExistingCompany(companyId);
    }
  }
}