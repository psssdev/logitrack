/**
 * @description This ruleset enforces a multi-tenant security model where companies own their data and access is restricted based on company membership.
 * @dataStructure The database is structured with a top-level `companies` collection, and each company has subcollections for `orders` and `drivers`. Data required for authorization (like `companyId`) is denormalized onto child documents.
 * @keySecurityDecisions
 *   - Only authenticated users can access any data. Anonymous users are not permitted.
 *   - Company documents can only be created. Updates and Deletes are forbidden.
 *   - Listing of the root `companies` collection is not allowed.
 *   - Orders and Drivers are owned by a `companyId` and cannot be moved to another company after creation.
 * @denormalization For performance and security, the `orders` and `drivers` documents contain a `companyId` field, allowing rules to validate company ownership without additional `get()` operations.
 * @structuralSegregation The `orders` and `drivers` are stored in company-specific subcollections to ensure that all data within a collection shares the same access control requirements.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures the root-level `companies` collection, allowing only authenticated users to create new companies. Updates and deletes are not allowed.
     * @path /companies/{companyId}
     * @allow (create) - An authenticated user can create a new company document.
     * @deny (update) - No one can update a company document.
     * @deny (delete) - No one can delete a company document.
     * @principle Restricts modifications to company records after creation.
     */
    match /companies/{companyId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures the `orders` subcollection under a company, ensuring that only authenticated users can create, read, update, and delete orders belonging to that company.
     * @path /companies/{companyId}/orders/{orderId}
     * @allow (create) - An authenticated user can create a new order under their company.
     * @allow (get) - An authenticated user can retrieve an order under their company.
     * @allow (update) - An authenticated user can modify an existing order under their company.
     * @allow (delete) - An authenticated user can delete an existing order under their company.
     * @deny (create) - An authenticated user cannot create an order with a mismatched `companyId`.
     * @deny (update) - An authenticated user cannot update an order with a mismatched `companyId`.
     * @deny (delete) - An authenticated user cannot delete an order with a mismatched `companyId`.
     * @principle Enforces company-level ownership for order data.
     */
    match /companies/{companyId}/orders/{orderId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.companyId == companyId;
      allow update: if isSignedIn() && request.resource.data.companyId == resource.data.companyId;
      allow delete: if isSignedIn() && resource.data.companyId == companyId;
    }

    /**
     * @description Secures the `drivers` subcollection under a company, ensuring that only authenticated users can create, read, update, and delete drivers belonging to that company.
     * @path /companies/{companyId}/drivers/{driverId}
     * @allow (create) - An authenticated user can create a new driver under their company.
     * @allow (get) - An authenticated user can retrieve a driver under their company.
     * @allow (update) - An authenticated user can modify an existing driver under their company.
     * @allow (delete) - An authenticated user can delete an existing driver under their company.
     * @deny (create) - An authenticated user cannot create a driver with a mismatched `companyId`.
     * @deny (update) - An authenticated user cannot update a driver with a mismatched `companyId`.
     * @deny (delete) - An authenticated user cannot delete a driver with a mismatched `companyId`.
     * @principle Enforces company-level ownership for driver data.
     */
    match /companies/{companyId}/drivers/{driverId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.companyId == companyId;
      allow update: if isSignedIn() && request.resource.data.companyId == resource.data.companyId;
      allow delete: if isSignedIn() && resource.data.companyId == companyId;
    }

    // ---- Helper functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}