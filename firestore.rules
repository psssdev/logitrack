/**
 * @file Firebase Security Rules for Firestore.
 *
 * @Core Philosophy: This ruleset enforces a multi-tenant security model where data is segregated by company.
 *  Users can only access resources (clients, addresses, orders) belonging to their associated company.
 *  User profiles are readable by their respective owners.
 *
 * @Data Structure:
 * - /users/{userId}: Stores public user profile information.
 * - /companies/{companyId}: Root collection for company-specific data.
 * - /companies/{companyId}/clients/{clientId}: Stores client information for a company.
 * - /companies/{companyId}/clients/{clientId}/addresses/{addressId}: Stores client addresses for a company.
 * - /companies/{companyId}/orders/{orderId}: Stores orders for a company.
 *
 * @Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Data within a /companies/{companyId} path is restricted to authenticated users.
 * - Listing of users is disallowed.
 *
 * @Denormalization for Authorization:
 *  - Company ID: Ensure that documents within a company's data tree (clients, addresses, orders) have the companyId denormalized onto them. This is essential for performant security rules that don't require expensive `get()` operations.  We will enforce this denormalization on `create` operations.
 *
 * @Structural Segregation:
 *  - Public user profiles are stored in a separate collection (/users/{userId}) from company-specific data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description: Controls access to user profile documents.
     * @path: /users/{userId}
     * @allow: (get, create, update, delete) - Authenticated user reads/writes own profile.
     * @deny: (get, create, update, delete) - Authenticated user tries to access another user's profile. Unauthenticated user tries to access any profile.
     * @principle: Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description: Controls access to client documents within a company.
     * @path: /companies/{companyId}/clients/{clientId}
     * @allow: (get, list, create, update, delete) - Authenticated user reads/writes data for their company.
     * @deny: (get, list, create, update, delete) - Unauthenticated user or user from another company tries to access data.
     * @principle: Enforces company-level data isolation.
     */
    match /companies/{companyId}/clients/{clientId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isCompanyUser(companyId) {
         return isSignedIn() && request.auth.uid == resource.data.companyId;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Controls access to origin documents within a company.
     * @path: /companies/{companyId}/origins/{originId}
     * @allow: (get, list, create, update, delete) - Authenticated user reads/writes data for their company.
     * @deny: (get, list, create, update, delete) - Unauthenticated user or user from another company tries to access data.
     * @principle: Enforces company-level data isolation.
     */
    match /companies/{companyId}/origins/{originId} {
       function isSignedIn() {
        return request.auth != null;
      }

      function isCompanyUser(companyId) {
         return isSignedIn() && request.auth.uid == resource.data.companyId;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Controls access to address documents within a client.
     * @path: /companies/{companyId}/clients/{clientId}/addresses/{addressId}
     * @allow: (get, list, create, update, delete) - Authenticated user reads/writes data for their company.
     * @deny: (get, list, create, update, delete) - Unauthenticated user or user from another company tries to access data.
     * @principle: Enforces company-level data isolation.
     */
    match /companies/{companyId}/clients/{clientId}/addresses/{addressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isCompanyUser(companyId) {
         return isSignedIn() && request.auth.uid == resource.data.companyId;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Controls access to order documents within a company.
     * @path: /companies/{companyId}/orders/{orderId}
     * @allow: (get, list, create, update, delete) - Authenticated user reads/writes data for their company.
     * @deny: (get, list, create, update, delete) - Unauthenticated user or user from another company tries to access data.
     * @principle: Enforces company-level data isolation.
     */
    match /companies/{companyId}/orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isCompanyUser(companyId) {
         return isSignedIn() && request.auth.uid == resource.data.companyId;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description: Controls access to company documents.
     * @path: /companies/{companyId}
     * @allow: (get) - Everyone can read company documents.
     * @deny: (create, update, delete) - Only an admin can perform writes.
     * @principle: Public read, restricted write.
     */
    match /companies/{companyId} {
        allow get: if true;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}