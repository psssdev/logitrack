/**
 * @file Firestore Security Rules
 * @core_philosophy This ruleset enforces a multi-tenant security model where users and data are segregated by company.
 *  Each company has its own isolated data store, and users are only authorized to access data within their assigned company.
 *  User profiles are stored at the root level for easy access, but their `companyId` field is used to enforce data access restrictions.
 * @data_structure The database is structured with top-level collections for `users` and `companies`.
 *  Company-specific data (clients, orders, drivers, origins) is stored in subcollections under the respective `companies/{companyId}` document.
 *  This hierarchical structure simplifies security rules and improves query performance.
 * @key_security_decisions
 *  - Users can only read and write their own profile data.
 *  - Companies are publicly readable to facilitate discovery, but write access is restricted (TODO: implement admin role).
 *  - Data within a company (clients, orders, drivers, origins) can only be accessed by authenticated users belonging to that company.
 *  - Listing of user documents is disallowed to prevent enumeration.
 *  - Strict ownership is enforced for all write operations.
 * @denormalization_for_authorization The `companyId` field is denormalized onto user profiles and other company-specific documents to enable efficient authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (get, update, delete) User with ID 'user123' can read/write their own profile.
     * @allow (create) User with ID 'user123' can create their own profile.
     * @deny (get, update, delete) User with ID 'user123' cannot read/write the profile of user 'user456'.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isOwner(userId) && resource.data.id == userId;
      allow delete: if isSignedIn() && isOwner(userId) && resource.data.id == userId;
    }

    /**
     * @description Allows anyone to read company data, but restricts creation, updates, and deletion.
     * @path /companies/{companyId}
     * @allow (get, list) Any user can read company data.
     * @deny (create, update, delete) No one can create, update, or delete company data without proper authorization (TODO: Implement admin role).
     * @principle Allows public read access for company information while restricting write access.
     */
    match /companies/{companyId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add company admin role check
    }

    /**
     * @description Allows company users to manage their clients.
     * @path /companies/{companyId}/clients/{clientId}
     * @allow (create) User in company 'company123' can create a client.
     * @allow (get, list, update, delete) User in company 'company123' can read/write clients within their company.
     * @deny (create, get, list, update, delete) User in company 'company456' cannot access clients of 'company123'.
     * @principle Enforces multi-tenancy: only users within the specified company can access client data.
     */
    match /companies/{companyId}/clients/{clientId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isMemberOfCompany(companyId) {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }

      allow get, list: if isMemberOfCompany(companyId);
      allow create: if isMemberOfCompany(companyId);
      allow update: if isMemberOfCompany(companyId);
      allow delete: if isMemberOfCompany(companyId);
    }

    /**
     * @description Allows company users to manage their shipment origins.
     * @path /companies/{companyId}/origins/{originId}
     * @allow (create) User in company 'company123' can create an origin.
     * @allow (get, list, update, delete) User in company 'company123' can read/write origins within their company.
     * @deny (create, get, list, update, delete) User in company 'company456' cannot access origins of 'company123'.
     * @principle Enforces multi-tenancy: only users within the specified company can access origin data.
     */
    match /companies/{companyId}/origins/{originId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isMemberOfCompany(companyId) {
          return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
        }

        allow get, list: if isMemberOfCompany(companyId);
        allow create: if isMemberOfCompany(companyId);
        allow update: if isMemberOfCompany(companyId);
        allow delete: if isMemberOfCompany(companyId);
    }

    /**
     * @description Allows company users to manage client addresses.
     * @path /companies/{companyId}/clients/{clientId}/addresses/{addressId}
     * @allow (create) User in company 'company123' can create an address for a client.
     * @allow (get, list, update, delete) User in company 'company123' can read/write addresses for clients within their company.
     * @deny (create, get, list, update, delete) User in company 'company456' cannot access addresses of clients in 'company123'.
     * @principle Enforces multi-tenancy: only users within the specified company can access client address data.
     */
    match /companies/{companyId}/clients/{clientId}/addresses/{addressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isMemberOfCompany(companyId) {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }

      allow get, list: if isMemberOfCompany(companyId);
      allow create: if isMemberOfCompany(companyId);
      allow update: if isMemberOfCompany(companyId);
      allow delete: if isMemberOfCompany(companyId);
    }

    /**
     * @description Allows company users to manage their orders.
     * @path /companies/{companyId}/orders/{orderId}
     * @allow (create) User in company 'company123' can create an order.
     * @allow (get, list, update, delete) User in company 'company123' can read/write orders within their company.
     * @deny (create, get, list, update, delete) User in company 'company456' cannot access orders of 'company123'.
     * @principle Enforces multi-tenancy: only users within the specified company can access order data.
     */
    match /companies/{companyId}/orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isMemberOfCompany(companyId) {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }

      allow get, list: if isMemberOfCompany(companyId);
      allow create: if isMemberOfCompany(companyId);
      allow update: if isMemberOfCompany(companyId);
      allow delete: if isMemberOfCompany(companyId);
    }

     /**
      * @description Allows server-side actions to create campaigns and authenticated users to manage them.
      * @path /companies/{companyId}/avisame_campaigns/{campaignId}
      * @allow (create) Server-side logic can create new campaigns.
      * @allow (get, list, update, delete) Authenticated users belonging to the company can manage campaigns.
      * @principle Enforces multi-tenancy while enabling server-side automation.
      */
    match /companies/{companyId}/avisame_campaigns/{campaignId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isMemberOfCompany(companyId) {
          return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
        }

        allow get, list: if isMemberOfCompany(companyId);
        allow create: if request.auth == null; // Allow server-side creation
        allow update: if isMemberOfCompany(companyId) || request.auth == null;
        allow delete: if isMemberOfCompany(companyId);
    }

    /**
     * @description Allows server-side actions to create delivery records and authenticated users to read them.
     * @path /companies/{companyId}/avisame_deliveries/{deliveryId}
     * @allow (create) Server-side logic can create new delivery records as part of a campaign.
     * @allow (get, list, update, delete) Authenticated users belonging to the company can manage delivery statuses.
     * @principle Enforces multi-tenancy for read/update while enabling server-side automation for creation.
     */
    match /companies/{companyId}/avisame_deliveries/{deliveryId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isMemberOfCompany(companyId) {
          return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
        }

        allow get, list: if isMemberOfCompany(companyId);
        allow create: if request.auth == null; // Allow server-side batch creation
        allow update: if isMemberOfCompany(companyId);
        allow delete: if isMemberOfCompany(companyId);
    }

    /**
     * @description Allows company users to manage their drivers.
     * @path /companies/{companyId}/drivers/{driverId}
     * @allow (create) User in company 'company123' can create a driver.
     * @allow (get, list, update, delete) User in company 'company123' can read/write drivers within their company.
     * @deny (create, get, list, update, delete) User in company 'company456' cannot access drivers of 'company123'.
     * @principle Enforces multi-tenancy: only users within the specified company can access driver data.
     */
     match /companies/{companyId}/drivers/{driverId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isMemberOfCompany(companyId) {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
      }

      allow get, list: if isMemberOfCompany(companyId);
      allow create: if isMemberOfCompany(companyId);
      allow update: if isMemberOfCompany(companyId);
      allow delete: if isMemberOfCompany(companyId);
    }
  }
}
