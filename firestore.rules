/**
 * @fileOverview Firestore Security Rules for the transport app.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant security model where data is primarily segregated by company.
 * Users have ownership of their profiles. Companies own their clients, origins, addresses, orders, and drivers.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only by the user themselves.
 * - /companies/{companyId}/clients/{clientId}: Clients belonging to a specific company.
 * - /companies/{companyId}/origins/{originId}: Origins belonging to a specific company.
 * - /companies/{companyId}/clients/{clientId}/addresses/{addressId}: Addresses associated with a specific client within a company.
 * - /companies/{companyId}/orders/{orderId}: Orders belonging to a specific company.
 *
 * Key Security Decisions:
 * - User profiles are private and only accessible to the owning user. Listing all users is disallowed.
 * - All company-owned data (clients, origins, addresses, orders) is only accessible to authenticated users.  For simplicity, this initial ruleset does not implement granular roles or permissions within a company.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (get, create, update, delete, list) if request.auth.uid == userId
     * @deny (get, create, update, delete, list) if request.auth.uid != userId
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows authenticated users to read and write clients within their company.
     * @path /companies/{companyId}/clients/{clientId}
     * @allow (get, create, update, delete, list) if isSignedIn()
     * @deny (get, create, update, delete, list) if !isSignedIn()
     * @principle Enforces company-level access for client data.
     */
    match /companies/{companyId}/clients/{clientId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows authenticated users to read and write origins within their company.
     * @path /companies/{companyId}/origins/{originId}
     * @allow (get, create, update, delete, list) if isSignedIn()
     * @deny (get, create, update, delete, list) if !isSignedIn()
     * @principle Enforces company-level access for origin data.
     */
    match /companies/{companyId}/origins/{originId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows authenticated users to read and write addresses for clients within their company.
     * @path /companies/{companyId}/clients/{clientId}/addresses/{addressId}
     * @allow (get, create, update, delete, list) if isSignedIn()
     * @deny (get, create, update, delete, list) if !isSignedIn()
     * @principle Enforces company-level access for address data.
     */
    match /companies/{companyId}/clients/{clientId}/addresses/{addressId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows authenticated users to read and write orders within their company.
     * @path /companies/{companyId}/orders/{orderId}
     * @allow (get, create, update, delete, list) if isSignedIn()
     * @deny (get, create, update, delete, list) if !isSignedIn()
     * @principle Enforces company-level access for order data.
     */
    match /companies/{companyId}/orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}