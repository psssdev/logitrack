{
  "entities": {
    "Company": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Company",
      "type": "object",
      "description": "Represents a transport company using the system. Enables multi-tenant support.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the company."
        },
        "nomeFantasia": {
          "type": "string",
          "description": "The trade name of the company."
        },
        "cnpj": {
          "type": "string",
          "description": "The company's CNPJ (optional)."
        },
        "logoUrl": {
          "type": "string",
          "description": "URL of the company's logo image."
        },
        "whatsappProvider": {
          "type": "string",
          "description": "JSON string containing the configuration for the WhatsApp provider (type, baseUrl, token, sender).",
          "format": "json-string"
        },
        "msgTemplates": {
          "type": "string",
          "description": "JSON string containing templates for WhatsApp messages (recebido, emRota, entregue).",
          "format": "json-string"
        },
        "codigoPrefixo": {
          "type": "string",
          "description": "Prefix for the tracking code (e.g., 'TR-')."
        },
        "linkBaseRastreio": {
          "type": "string",
          "description": "Base URL for tracking links.  The tracking code will be appended to this URL.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "nomeFantasia",
        "whatsappProvider",
        "msgTemplates",
        "codigoPrefixo",
        "linkBaseRastreio"
      ]
    },
    "Order": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Order",
      "type": "object",
      "description": "Represents an order in the transport system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the order."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N Order)"
        },
        "codigoRastreio": {
          "type": "string",
          "description": "Unique tracking code for the order (e.g., TR-ABC123)."
        },
        "nomeCliente": {
          "type": "string",
          "description": "Name of the customer."
        },
        "telefone": {
          "type": "string",
          "description": "Customer's phone number (E.164 format)."
        },
        "origem": {
          "type": "string",
          "description": "Origin of the shipment."
        },
        "destino": {
          "type": "string",
          "description": "Destination of the shipment."
        },
        "valorEntrega": {
          "type": "number",
          "description": "Delivery value."
        },
        "formaPagamento": {
          "type": "string",
          "description": "Payment method (pix, dinheiro, cartao, boleto, link).",
          "format": "enum"
        },
        "pago": {
          "type": "boolean",
          "description": "Indicates if the order is paid."
        },
        "status": {
          "type": "string",
          "description": "Order status (PENDENTE, EM_ROTA, ENTREGUE, CANCELADA).",
          "format": "enum"
        },
        "motoristaId": {
          "type": "string",
          "description": "Reference to Driver. (Relationship: Driver 1:N Order) (Optional)",
          "format": "uuid"
        },
        "observacao": {
          "type": "string",
          "description": "Optional notes about the order."
        },
        "timeline": {
          "type": "array",
          "description": "Array of status changes with timestamps and user references.",
          "items": {
            "type": "string"
          }
        },
        "messages": {
          "type": "array",
          "description": "Array of messages sent related to the order.",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the order was created.",
          "format": "date-time"
        },
        "createdBy": {
          "type": "string",
          "description": "User who created the order."
        }
      },
      "required": [
        "id",
        "companyId",
        "codigoRastreio",
        "nomeCliente",
        "telefone",
        "origem",
        "destino",
        "valorEntrega",
        "formaPagamento",
        "pago",
        "status",
        "timeline",
        "messages",
        "createdAt",
        "createdBy"
      ]
    },
    "Driver": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Driver",
      "type": "object",
      "description": "Represents a driver.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the driver."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N Driver)"
        },
        "nome": {
          "type": "string",
          "description": "Driver's name."
        },
        "telefone": {
          "type": "string",
          "description": "Driver's phone number."
        },
        "placa": {
          "type": "string",
          "description": "Vehicle license plate."
        },
        "ativo": {
          "type": "boolean",
          "description": "Indicates if the driver is active."
        }
      },
      "required": [
        "id",
        "companyId",
        "nome",
        "telefone",
        "placa",
        "ativo"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "companies/{companyId}",
        "definition": {
          "entityName": "Company",
          "schema": {
            "$ref": "#/backend/entities/Company"
          },
          "description": "Stores company-specific settings and data. The `companyId` is used for multi-tenant isolation.",
          "params": [
            {
              "name": "companyId",
              "description": "Unique identifier for the company."
            }
          ]
        }
      },
      {
        "path": "companies/{companyId}/orders/{orderId}",
        "definition": {
          "entityName": "Order",
          "schema": {
            "$ref": "#/backend/entities/Order"
          },
          "description": "Stores order information for a specific company. Includes denormalized 'companyId' for authorization independence.",
          "params": [
            {
              "name": "companyId",
              "description": "Unique identifier for the company."
            },
            {
              "name": "orderId",
              "description": "Unique identifier for the order."
            }
          ]
        }
      },
      {
        "path": "companies/{companyId}/drivers/{driverId}",
        "definition": {
          "entityName": "Driver",
          "schema": {
            "$ref": "#/backend/entities/Driver"
          },
          "description": "Stores driver information for a specific company. Includes denormalized 'companyId' for authorization independence.",
          "params": [
            {
              "name": "companyId",
              "description": "Unique identifier for the company."
            },
            {
              "name": "driverId",
              "description": "Unique identifier for the driver."
            }
          ]
        }
      }
    ],
    "reasoning": "This design prioritizes security, scalability, and debuggability based on the provided requirements. It utilizes denormalization to ensure Authorization Independence, structural segregation for homogeneous security postures, and access modeling for consistent authorization patterns.\n\n**Authorization Independence (Denormalization):**\nThe `orders` subcollection includes `companyId`, eliminating the need for `get()` calls to the parent `companies` document to enforce company-level access control.  Similarly, if driver-level access is implemented, the `orders` collection includes a `driverId`. This is crucial for atomic operations (transactions/batches) when creating orders and ensures that security rules can be evaluated independently without relying on parent data. The `companyId` is also on the `drivers` collection, so that queries can easily be made about drivers within the tenant.\n\n**Structural Segregation:**\nAll documents within the `companies/{companyId}/orders` collection share the same security requirements: only authorized users (admins, operators, drivers of that company) can access them. This avoids mixing data with different access needs in the same collection. All `drivers` share the same security posture of being accessible by admins, operators and themselves (drivers).\n\n**Access Modeling:**\n*   **Company Data:** The `companies` collection is designed for administrative access, with each document representing a separate tenant (company). Access is controlled through authentication and authorization rules.\n*   **Order Data:**  Orders are stored within a subcollection `companies/{companyId}/orders`. This structure enforces clear ownership by the company. Access is granted based on the user's role within the company and the `companyId` stored in the `orders` document.\n*   **Driver Data:** Drivers are stored within the `companies/{companyId}/drivers` collection to associate them with companies. This structure is straightforward and ensures data integrity.\n\n**QAPs (Rules are not Filters):**\nThe structure supports secure `list` operations. For example, listing orders for a specific company is done via querying the `companies/{companyId}/orders` collection.  The security rules can then enforce that the authenticated user has the correct permissions to access orders for that `companyId`.  Because security rules do not act as filters, the queries will be secure and predictable.\n\n**Invariants:**\nThe structure supports the integrity of ownership (`companyId`), timestamps (`createdAt`), and denormalized data (e.g., `companyId` in `orders`). Security rules can enforce that these fields are immutable after creation, preventing unauthorized modifications."
  }
}